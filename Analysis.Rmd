---
title: "Analyse COVID data"
author: "Hanne Oberman"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
    number_sections: true
---

<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 20px;
  color: DarkBlue;
}
h1 { /* Header 1 */
  font-size: 18px;
}
h2 { /* Header 2 */
    font-size: 16px;
}
h3 { /* Header 3 */
  font-size: 14px;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 12px;
}
</style>

---

# Packages and functions used
```{r setup, include=TRUE, message=FALSE, warning=TRUE}
# setup environment
library(haven)      # For importing SPSS data
library(readxl)     # For reading excel files
library(tidyverse)  # All things useful
library(mice)       # For incomplete data analysis
library(miceadds)   # Additions to mice
library(ggmice)     # Plotting device for mice
library(lme4)       # Linear mixed-effect modeling
library(plyr)       # Data wrangling
library(magrittr)   # Pipes in R
library(lme4)       # linear mixed effects models
library(broom.mixed)# tidy and glance models for mixed effects classes
```

---

# Read in the imputed data
```{r}
imp <- readRDS("imp_20it.RDS")
```

---

# Make into long format
```{r}
long <- mice::complete(imp_20it, "long", include = TRUE)
```

---

# Post-processing the imputations

## voeg kleine huishoudenscategorieen samen
```{r}
long$q29[long$q29 == 6] <- 5
long$q29[long$q29 == 7] <- 5
```

## voeg opleidingsniveaus samen
```{r}
long$edu[long$edu < 4] <- 1
long$edu[long$edu == 4 | long$edu == 5] <- 2
long$edu[long$edu > 5] <- 3
```

## corrigeer factor levels
vars_factor <- c("edu", "oesch", "q29", "sekse", "etn_herkomst")
long_factor <- long %>% 
  mutate(
    across(vars_factor, round),
    across(vars_factor, as.factor))
levels(long_factor$sekse) <- c("Man", "Vrouw")
levels(long_factor$edu)<- c("Hoog", "Middel", "Laag")
# levels(long_factor$BG_AGE4_MIN)<- c("18-34","35-49","50-64","65+")
levels(long_factor$etn_herkomst)<- c("Nederlandse achtergrond", "Westerse migratieachtergrond", "Niet-westerse migratieachtergrond")
levels(long_factor$q29)<- c("Alleenstaand zonder kinderen", "Alleenstaand met kinderen", "Samenwonend met partner met thuiswonende kinderen",
                            "Samenwonend met partner zonder thuiswonende kinderen", "Anders")

# post-processing of scale variables
# ment = q49_1/2/3/4/5/6 #mentale gevolgen
# econ = q52/q53/q54 #economische
# onvr = q48_1/9/10/11/12 #onvrede met beleid
# drei = q47_1/2/3 #dreiging ervaren
# cont = q33_1/2/3/4/5/6 #sociaal contact
# eenz = q34_ (eenzaamheid)
# hulp = q38_ (hulp ontvangen)
# medi = q31_ (mediagebruik)
# rond = q59 (rondkomen)
# - q60_2/3/4/8/10/12 (vertrouwen)

long_scales <- long_factor %>% 
  rowwise() %>% 
  mutate(ment = mean(c(q49_1, q49_2, q49_3,  q49_4, q49_5, q49_6)),
         econ = mean(c(q52, q53, q54)),
         onvr = mean(c(q48_1, q48_9, q48_10,  q48_11, q48_12)),
         drei = mean(c(q47_1, q47_2, q47_3)),
         cont = mean(c(q33_1, q33_2, q33_3,  q33_4, q33_5, q33_6)),
         eenz = mean(c(q34_1, q34_2, q34_3,  q34_4, q34_5)),
         hulp = mean(c(q38_1, q38_2, q38_3,  q38_4)),
         medi = mean(c(q31_1, q31_2, q31_3,  q31_4, q31_5, q31_6, q31_7)), 
         .keep = "unused")

# TODO: convert age to categories
# TODO: rename q43 to gezondheid, q59 to rondkomen
# TODO: recode meting into months

# converteer terug naar mids object
imp_post <- as.mids(long_scales)
saveRDS(imp_post, "./imputaties.RDS")

######################
## analyses
######################

# fit_all <- imp_post %>% 
#   complete("all") %>% 
#   purrr::map(~lme4::lmer(q60_1 ~ . * meting - id + edu:etn_herkomst:econ + (1|id), data = .x)) 
# fit_all %>% 
#   pool() %>% 
#   broom.mixed::tidy()
# results_vert <- mitml::testEstimates(as.mitml.result(fit_all), extra.pars = TRUE)
# write.csv2(results_vert$estimates, "vertrouwen2.csv")
# saveRDS(fit_all, "vertrouwen.RDS")

fit_all <- imp %>% 
  complete("all") %>% 
  purrr::map(~lme4::lmer(q60_1 ~ . * meting - id + edu:etn_herkomst:econ + (1 + meting|id), data = .x)) 
fit_all %>% 
  pool() %>% 
  broom.mixed::tidy()
results_vert <- mitml::testEstimates(as.mitml.result(fit_all), extra.pars = TRUE)
write.csv2(results_vert$estimates, "vertrouwen_random_time_effect.csv")
saveRDS(fit_all, "vertrouwen_random_time_effect.RDS")

# fit_all <- imp_post %>% 
#   mice::complete("all") %>% 
#   purrr::map(~lme4::lmer(ment ~ . * meting - id + edu:etn_herkomst:econ + (1|id), data = .x)) 
# fit_all %>% 
#   mice::pool() %>% 
#   broom.mixed::tidy()
# results_ment <- mitml::testEstimates(as.mitml.result(fit_all), extra.pars = TRUE)
# write.csv2(results_ment$estimates, "mentaal2.csv")
# saveRDS(fit_all, "mentaal.RDS")

fit_all <- imp_post %>% 
  mice::complete("all") %>% 
  purrr::map(~lme4::lmer(ment ~ . * meting - id + edu:etn_herkomst:econ + (1 + meting |id), data = .x)) 
fit_all %>% 
  mice::pool() %>% 
  broom.mixed::tidy()
results_ment <- mitml::testEstimates(as.mitml.result(fit_all), extra.pars = TRUE)
write.csv2(results_ment$estimates, "mentaal_random_time_effects.csv")
saveRDS(fit_all, "mentaal_random_time_effect.RDS")

# Analysis
```{r}
fit <- lmer(q60_1 ~ )
```


