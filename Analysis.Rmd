---
title: "Analyse COVID data"
author: "Hanne Oberman"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
    number_sections: true
---

<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 20px;
  color: DarkBlue;
}
h1 { /* Header 1 */
  font-size: 18px;
}
h2 { /* Header 2 */
    font-size: 16px;
}
h3 { /* Header 3 */
  font-size: 14px;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 12px;
}
</style>

---

# Packages and functions used
```{r setup, include=TRUE, message=FALSE, warning=TRUE}
# setup environment
library(haven)      # For importing SPSS data
library(readxl)     # For reading excel files
library(tidyverse)  # All things useful
library(mice)       # For incomplete data analysis
library(miceadds)   # Additions to mice
library(ggmice)     # Plotting device for mice
library(lme4)       # Linear mixed-effect modeling
library(plyr)       # Data wrangling
library(magrittr)   # Pipes in R
library(lme4)       # linear mixed effects models
library(broom.mixed)# tidy and glance models for mixed effects classes
```

---

# Read in the imputed data
```{r}
imp <- readRDS("imp_20it.RDS")
```

---

# Make into long format
```{r}
long <- mice::complete(imp, "long", include = TRUE)
```

---

# Post-processing the imputations

## Combine smaller household categories into one 'other'
```{r}
long$q29[long$q29 == 6] <- 5
long$q29[long$q29 == 7] <- 5
long <- long %>% mutate(
  q29 = as.factor(q29)
)
levels(long$q29)<- c("Alleenstaand zonder kinderen", "Alleenstaand met kinderen", "Samenwonend met partner met thuiswonende kinderen",
                            "Samenwonend met partner zonder thuiswonende kinderen", "Anders")
```

## Combine education levels into three names categories
```{r}
long$edu[long$edu < 4] <- 1
long$edu[long$edu == 4 | long$edu == 5] <- 2
long$edu[long$edu > 5] <- 3
long <- long %>% mutate(
  edu = as.factor(edu)
)
levels(long$edu)<- c("Hoog", "Middel", "Laag")
```

## Label factor levels for sex and ethnic background
```{r}
long$sekse <- as.factor(long$sekse)
levels(long$sekse) <- c("Man", "Vrouw")
long$etn_herkomst <- as.factor(long$etn_herkomst)
levels(long$etn_herkomst)<- c("Nederlandse achtergrond", "Westerse migratieachtergrond", "Niet-westerse migratieachtergrond")
```

```{r}
## Categorize age
# long <- long %>% mutate(
#   age = 2020-geboortejaar
# )
# levels(long$age_min)<- c("18-34","35-49","50-64","65+")
```

## Combine items of scale contructs into variables
```{r}
long <- long %>% 
  rowwise() %>% 
  mutate(ment = mean(c(q49_1, q49_2, q49_3,  q49_4, q49_5, q49_6)), #mentale gevolgen
         econ = mean(c(q52, q53, q54)),  #economische
         onvr = mean(c(q48_1, q48_9, q48_10,  q48_11, q48_12)), #onvrede met beleid
         drei = mean(c(q47_1, q47_2, q47_3)), #dreiging ervaren
         cont = mean(c(q33_1, q33_2, q33_3,  q33_4, q33_5, q33_6)),  #sociaal contact
         eenz = mean(c(q34_1, q34_2, q34_3,  q34_4, q34_5)), #eenzaamheid
         hulp = mean(c(q38_1, q38_2, q38_3,  q38_4)), #hulp ontvangen
         medi = mean(c(q31_1, q31_2, q31_3,  q31_4, q31_5, q31_6, q31_7)), #mediagebruik
         rond = mean(q59), #rondkomen
         gezo = mean(q43), #gezondheid
         .keep = "unused")
```

## Convert back to imputation object
```{r}
imp_post <- as.mids(long)
saveRDS(imp_post, "./imputaties.RDS")
```

# Analyses

# Empty model
```{r}
fit <- imp_post %>% 
  complete("all") %>% 
  purrr::map(~lme4::lmer(q60_1 ~ meting + (1|id), data = .x)) 
fit %>% 
  pool() %>% 
  broom.mixed::tidy()
results_vert <- mitml::testEstimates(as.mitml.result(fit), extra.pars = TRUE)
write.csv2(results_vert$estimates, "vertrouwen.csv")
saveRDS(fit, "vertrouwen.RDS")
```
